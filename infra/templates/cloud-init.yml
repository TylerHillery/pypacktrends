#cloud-config
ssh_pwauth: false
groups:
  - docker
users:
- name: "{{ vps_username }}"
  groups: sudo, docker, admin
  sudo: ALL=(ALL) NOPASSWD:ALL
  shell: /bin/bash
  lock_passwd: true

runcmd:
  # ssh configs
  - sed -i '/PermitRootLogin/d' /etc/ssh/sshd_config
  - echo "PermitRootLogin without-password" >> /etc/ssh/sshd_config
  - systemctl restart sshd

  # disable needrestart prompts
  - mkdir -p /etc/needrestart/conf.d
  - echo "\$nrconf{kernelhints} = -1;" > /etc/needrestart/conf.d/99disable-prompt.conf

  # system updates
  - apt update
  - DEBIAN_FRONTEND=noninteractive apt upgrade -y --allow-downgrades --allow-remove-essential --allow-change-held-packages

  # docker configs
  - curl -fssl https://get.docker.com | sh

  # tailscale configs
  - curl -fsSL https://tailscale.com/install.sh | sh
  - sh -c "echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf && echo 'net.ipv6.conf.all.forwarding = 1' | sudo tee -a /etc/sysctl.d/99-tailscale.conf && sudo sysctl -p /etc/sysctl.d/99-tailscale.conf"
  - tailscale up --ssh --accept-routes --authkey={{ tailscale_auth_key }}

  # install uv
  - curl -LsSf https://astral.sh/uv/install.sh -o /tmp/uv_install.sh # curl: (23) Failed writing body (1311 != 1378)
  - HOME="/root" UV_UNMANAGED_INSTALL="/usr/local/bin" sh /tmp/uv_install.sh # https://github.com/astral-sh/uv/issues/6965

  # make logs dir
  - sudo -u {{ vps_username }} mkdir /home/{{ vps_username }}/logs

  # create dbtdocs directory and set ownership
  - mkdir -p {{ vps_project_path }}/dbt/target
  - chown {{ vps_username }}:{{ vps_username }} {{ vps_project_path }}/dbt/target

  # clone the repository
  - sudo -u {{ vps_username }} git clone https://github.com/{{ github_username }}/{{ project_name }}.git {{ vps_project_path }}

  # start containers using full path to docker-compose.yml
  - sudo -u {{ vps_username }} docker compose -f {{ vps_project_path }}/docker-compose.yml up -d

  # ufw configs
  - ufw allow OpenSSH
  - ufw default deny incoming
  - ufw enable
